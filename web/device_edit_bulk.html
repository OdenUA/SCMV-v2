<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Edit Bulk - –û—á–∏—Å—Ç–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #00d9ff;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .section {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #0f3460;
        }
        .section h2 {
            margin-top: 0;
            color: #e94560;
            font-size: 1.1em;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 0.9em;
        }
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #1a1a2e;
            color: #eee;
            font-family: 'Consolas', monospace;
            font-size: 14px;
        }
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus {
            outline: none;
            border-color: #00d9ff;
        }
        textarea {
            min-height: 200px;
            resize: vertical;
        }
        .row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .row > div {
            flex: 1;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #00d9ff;
            color: #1a1a2e;
        }
        .btn-primary:hover:not(:disabled) {
            background: #00b8d9;
        }
        .btn-danger {
            background: #e94560;
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background: #c73e54;
        }
        .btn-secondary {
            background: #0f3460;
            color: #eee;
        }
        .btn-secondary:hover:not(:disabled) {
            background: #1a4a7a;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        #status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .status-connected {
            background: #0a3d0a;
            border: 1px solid #0f0;
            color: #0f0;
        }
        .status-disconnected {
            background: #3d0a0a;
            border: 1px solid #f00;
            color: #f00;
        }
        .status-processing {
            background: #3d3d0a;
            border: 1px solid #ff0;
            color: #ff0;
        }
        #log {
            background: #0a0a1a;
            border: 1px solid #0f3460;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        .log-success {
            color: #0f0;
        }
        .log-error {
            color: #f00;
        }
        .log-info {
            color: #00d9ff;
        }
        .log-warn {
            color: #ff0;
        }
        .progress-bar {
            height: 20px;
            background: #0f3460;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #e94560);
            transition: width 0.3s;
            width: 0%;
        }
        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 0.9em;
            color: #aaa;
        }
        .settings-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }
        .settings-row label {
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .settings-row input[type="number"] {
            width: 80px;
            padding: 5px;
            border: 1px solid #0f3460;
            border-radius: 4px;
            background: #1a1a2e;
            color: #eee;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Device Edit Bulk - –û—á–∏—Å—Ç–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h1>
        
        <div id="status" class="status-disconnected">‚ö´ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
        
        <div class="section">
            <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <div class="row">
                <div>
                    <label for="loginUser">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</label>
                    <input type="text" id="loginUser" placeholder="username">
                </div>
                <div>
                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="loginPassword" placeholder="password">
                </div>
            </div>
            <div class="buttons">
                <button id="connectBtn" class="btn-primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                <button id="disconnectBtn" class="btn-secondary" disabled>–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
        </div>
        
        <div class="section">
            <h2>üìù ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–∫–∞–∂–¥—ã–π ID –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ)</h2>
            <textarea id="deviceIds" placeholder="795
1574
820
1722
873
..."></textarea>
            <div class="settings-row" style="margin-top: 15px;">
                <label>
                    –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–º—Å):
                    <input type="number" id="delayMs" value="500" min="100" max="5000">
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="workstatusEnabled" checked>
                    workstatus: 1
                </label>
            </div>
        </div>
        
        <div class="section">
            <h2>üöÄ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</h2>
            <div class="buttons">
                <button id="startBtn" class="btn-primary" disabled>‚ñ∂ –ù–∞—á–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É</button>
                <button id="stopBtn" class="btn-danger" disabled>‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0 / 0</div>
        </div>
        
        <div class="section">
            <h2>üìã –õ–æ–≥</h2>
            <button id="clearLogBtn" class="btn-secondary" style="margin-bottom: 10px;">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <div id="log"></div>
        </div>
    </div>

    <script>
        // WebSocket configuration
        const wsUrl = "wss://scmv.vpngps.com:4445";
        
        // State
        let socket = null;
        let authUid = null;
        let authUser = '';
        let authPwd = '';
        let isLoggedIn = false;
        let isProcessing = false;
        let shouldStop = false;
        let currentIndex = 0;
        let deviceIdsList = [];
        let pendingRequestId = null;
        
        // DOM elements
        const statusDiv = document.getElementById('status');
        const loginUserInput = document.getElementById('loginUser');
        const loginPasswordInput = document.getElementById('loginPassword');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const deviceIdsTextarea = document.getElementById('deviceIds');
        const delayMsInput = document.getElementById('delayMs');
        const workstatusCheckbox = document.getElementById('workstatusEnabled');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const logDiv = document.getElementById('log');
        const clearLogBtn = document.getElementById('clearLogBtn');
        
        // Load saved credentials
        try {
            const savedUser = localStorage.getItem('dt_user');
            const savedPwd = localStorage.getItem('dt_pwd');
            if (savedUser) loginUserInput.value = savedUser;
            if (savedPwd) loginPasswordInput.value = savedPwd;
        } catch (e) {}
        
        // Logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status-${type}`;
        }
        
        function updateProgress() {
            const total = deviceIdsList.length;
            const percent = total > 0 ? (currentIndex / total) * 100 : 0;
            progressFill.style.width = `${percent}%`;
            progressText.textContent = `${currentIndex} / ${total}`;
        }
        
        // WebSocket functions
        function connect() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                log('–£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ', 'warn');
                return;
            }
            
            log('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...', 'info');
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                updateStatus('üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'connected');
                log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                // Auto-login if credentials available
                if (loginUserInput.value && loginPasswordInput.value) {
                    sendLogin();
                }
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    // Log received message name for debugging
                    if (data.name) {
                        log(`üì© –ü–æ–ª—É—á–µ–Ω–æ: ${data.name}`, 'info');
                    }
                    handleMessage(data);
                } catch (e) {
                    log(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${e.message}`, 'error');
                }
            };
            
            socket.onclose = function() {
                updateStatus('‚ö´ –û—Ç–∫–ª—é—á–µ–Ω–æ', 'disconnected');
                log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω', 'warn');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                startBtn.disabled = true;
                isLoggedIn = false;
                isProcessing = false;
            };
            
            socket.onerror = function(err) {
                log(`–û—à–∏–±–∫–∞ WebSocket: ${err.message || 'Unknown'}`, 'error');
            };
        }
        
        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
        }
        
        function sendRequest(req) {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                log('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω', 'error');
                return false;
            }
            const msg = JSON.stringify(req);
            console.log('send:' + msg);
            socket.send(msg);
            return true;
        }
        
        function sendLogin() {
            authUser = loginUserInput.value;
            authPwd = loginPasswordInput.value;
            
            if (!authUser || !authPwd) {
                log('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }
            
            log(`–õ–æ–≥–∏–Ω: ${authUser}...`, 'info');
            
            const req = {
                name: "login",
                type: "login",
                mid: 0,
                act: "setup",
                usr: authUser,
                pwd: authPwd,
                uid: 0,
                lang: "en"
            };
            sendRequest(req);
        }
        
        function handleMessage(data) {
            // Debug: log all incoming messages
            console.log('recv:', data);
            
            // Login response - check multiple formats
            if (data.name === "login") {
                // Format 1: data.res[0].uid
                if (data.res && data.res[0] && data.res[0].uid) {
                    authUid = data.res[0].uid;
                    isLoggedIn = true;
                    log(`‚úÖ –õ–æ–≥–∏–Ω —É—Å–ø–µ—à–µ–Ω (uid: ${authUid})`, 'success');
                    startBtn.disabled = false;
                    return;
                }
                // Format 2: data.uid directly
                if (data.uid) {
                    authUid = data.uid;
                    isLoggedIn = true;
                    log(`‚úÖ –õ–æ–≥–∏–Ω —É—Å–ø–µ—à–µ–Ω (uid: ${authUid})`, 'success');
                    startBtn.disabled = false;
                    return;
                }
                // Error
                log(`‚ùå –û—à–∏–±–∫–∞ –ª–æ–≥–∏–Ω–∞: ${data.msg || JSON.stringify(data)}`, 'error');
                isLoggedIn = false;
                return;
            }
            
            // Device Edit response
            if (data.name === "Device Edit") {
                if (pendingRequestId !== null) {
                    const cols = data.cols || (data.res && data.res[0] && data.res[0].cols);
                    if (cols && cols.id) {
                        log(`‚úÖ ID ${cols.id} - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ`, 'success');
                    } else if (data.err) {
                        log(`‚ùå ID ${pendingRequestId} - –æ—à–∏–±–∫–∞: ${data.err}`, 'error');
                    } else {
                        log(`‚úÖ ID ${pendingRequestId} - –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω`, 'success');
                    }
                    pendingRequestId = null;
                    
                    // Continue processing
                    if (isProcessing && !shouldStop) {
                        const delay = parseInt(delayMsInput.value) || 500;
                        setTimeout(processNext, delay);
                    }
                }
                return;
            }
            
            // Generic response for Device Edit (some servers return different format)
            if (pendingRequestId !== null && data.res) {
                log(`‚úÖ ID ${pendingRequestId} - –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω`, 'success');
                pendingRequestId = null;
                
                if (isProcessing && !shouldStop) {
                    const delay = parseInt(delayMsInput.value) || 500;
                    setTimeout(processNext, delay);
                }
            }
        }
        
        function sendDeviceEdit(deviceId) {
            const cols = {
                id: String(deviceId),
                iccid: "",
                phone: ""
            };
            
            if (workstatusCheckbox.checked) {
                cols.workstatus = "1";
            }
            
            const req = {
                name: "Device Edit",
                type: "etbl",
                mid: 2,
                act: "rowsave",
                cols: cols,
                usr: authUser,
                pwd: authPwd,
                uid: authUid,
                lang: "en"
            };
            
            pendingRequestId = deviceId;
            log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞: ID ${deviceId}`, 'info');
            return sendRequest(req);
        }
        
        function parseDeviceIds() {
            const text = deviceIdsTextarea.value.trim();
            if (!text) return [];
            
            return text.split(/[\n\r]+/)
                .map(line => line.trim())
                .filter(line => line && /^\d+$/.test(line));
        }
        
        function processNext() {
            if (shouldStop || currentIndex >= deviceIdsList.length) {
                finishProcessing();
                return;
            }
            
            const deviceId = deviceIdsList[currentIndex];
            currentIndex++;
            updateProgress();
            
            if (!sendDeviceEdit(deviceId)) {
                log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –¥–ª—è ID ${deviceId}`, 'error');
                // Continue anyway
                const delay = parseInt(delayMsInput.value) || 500;
                setTimeout(processNext, delay);
            }
        }
        
        function startProcessing() {
            if (!isLoggedIn) {
                log('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', 'error');
                return;
            }
            
            deviceIdsList = parseDeviceIds();
            if (deviceIdsList.length === 0) {
                log('–°–ø–∏—Å–æ–∫ ID –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è', 'error');
                return;
            }
            
            log(`üöÄ –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${deviceIdsList.length} —É—Å—Ç—Ä–æ–π—Å—Ç–≤`, 'info');
            
            isProcessing = true;
            shouldStop = false;
            currentIndex = 0;
            
            startBtn.disabled = true;
            stopBtn.disabled = false;
            updateStatus('üü° –û–±—Ä–∞–±–æ—Ç–∫–∞...', 'processing');
            updateProgress();
            
            processNext();
        }
        
        function stopProcessing() {
            shouldStop = true;
            log('‚èπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞...', 'warn');
        }
        
        function finishProcessing() {
            isProcessing = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            if (shouldStop) {
                log(`‚èπ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${currentIndex} –∏–∑ ${deviceIdsList.length}`, 'warn');
                updateStatus('üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ (–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ)', 'connected');
            } else {
                log(`‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${deviceIdsList.length} —É—Å—Ç—Ä–æ–π—Å—Ç–≤`, 'success');
                updateStatus('üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ (–∑–∞–≤–µ—Ä—à–µ–Ω–æ)', 'connected');
            }
        }
        
        // Event listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        startBtn.addEventListener('click', startProcessing);
        stopBtn.addEventListener('click', stopProcessing);
        clearLogBtn.addEventListener('click', () => { logDiv.innerHTML = ''; });
        
        // Auto-connect on load
        // connect();
    </script>
</body>
</html>
