<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuel Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #0d6efd;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .summary-row {
            background-color: #b4d2ff !important;
            font-weight: bold;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        .error {
            color: #d32f2f;
            padding: 20px;
            background: #ffebee;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .meta-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .meta-info p {
            margin: 5px 0;
            color: #1976d2;
        }
        .print-btn {
            background: #0d6efd;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .print-btn:hover {
            background: #0d6efd;
        }
        @media print {
            .print-btn {
                display: none;
            }
            body {
                background: white;
            }
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="print-btn" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
        <h1>–û—Ç—á–µ—Ç –ø–æ —Ç–æ–ø–ª–∏–≤—É</h1>
        <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        <div id="error" class="error" style="display:none;"></div>
        <div id="metaInfo" class="meta-info" style="display:none;"></div>
        <div id="content"></div>
    </div>
    <script>
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ postMessage
        function loadReport() {
            try {
                // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–∫–Ω–∞
                window.addEventListener('message', function(event) {
                    // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ origins
                    // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É: if (event.origin !== window.location.origin) return;
                    
                    if (event.data && event.data.type === 'FUEL_REPORT_DATA') {
                        const data = event.data.data;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö
                        let fuelData = null;
                        
                        if (data && data.res && data.res[0] && data.res[0].f) {
                            fuelData = data.res[0].f;
                        } else if (data && data.res && Array.isArray(data.res) && data.res.length > 0) {
                            // –í–æ–∑–º–æ–∂–Ω–æ –¥–∞–Ω–Ω—ã–µ –≤ –¥—Ä—É–≥–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                            fuelData = data.res;
                        } else if (data && Array.isArray(data)) {
                            // –í–æ–∑–º–æ–∂–Ω–æ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É –º–∞—Å—Å–∏–≤
                            fuelData = data;
                        }
                        
                        if (!fuelData || !Array.isArray(fuelData) || fuelData.length === 0) {
                            showError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞: ' + JSON.stringify(data).substring(0, 200));
                            return;
                        }
                        
                        renderReport(data);
                    }
                });
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ opener'—É –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                if (window.opener) {
                    try {
                        window.opener.postMessage({
                            type: 'FUEL_REPORT_READY'
                        }, '*');
                    } catch (e) {
                        console.warn('Could not notify opener', e);
                    }
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
                setTimeout(function() {
                    const loadingDiv = document.getElementById('loading');
                    if (loadingDiv && loadingDiv.style.display !== 'none') {
                        loadingDiv.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–∫–Ω–∞...';
                    }
                }, 1000);
                
            } catch (e) {
                showError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
            }
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function renderReport(data) {
            document.getElementById('loading').style.display = 'none';
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const metaDiv = document.getElementById('metaInfo');
            const filter = data.filter || [];
            let dateFrom = '', dateTo = '', vehicleId = '';
            
            filter.forEach(f => {
                if (f.selectedpgdatefrom) dateFrom = new Date(f.selectedpgdatefrom[0]).toLocaleString('ru-RU');
                if (f.selectedpgdateto) dateTo = new Date(f.selectedpgdateto[0]).toLocaleString('ru-RU');
                if (f.selectedvihicleid) vehicleId = f.selectedvihicleid[0];
            });
            
            metaDiv.innerHTML = `
                <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> —Å ${dateFrom} –ø–æ ${dateTo}</p>
                <p><strong>ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</strong> ${vehicleId}</p>
            `;
            metaDiv.style.display = 'block';
            
            const rawData = data.res[0].f;
            
            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏ —Å—Ç—Ä–æ–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            const analysis = analyzeData(rawData);
            
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = '';
            
            // 1. –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ –±–∞–∫–∞–º
            contentDiv.appendChild(createSummaryTable(analysis));
            
            // 2. –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø—Ä–∞–≤–æ–∫ –∏ —Å–ª–∏–≤–æ–≤
            contentDiv.appendChild(createRefuelingsTable(analysis));
            
            // 3. –°—É—Ç–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
            contentDiv.appendChild(createDailyTable(analysis));
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ (—Ñ–æ—Ä–º—É–ª–∞ Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –∫–º
        }
        
        function analyzeData(rawData) {
            if (!rawData || rawData.length === 0) {
                return {
                    tankName: '–¢–æ–ø–ª–∏–≤–Ω—ã–π –±–∞–∫',
                    startLevel: 0,
                    endLevel: 0,
                    refuelings: [],
                    drains: [],
                    dailyData: [],
                    totalConsumption: 0
                };
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ —Å –Ω—É–ª–µ–≤—ã–º —É—Ä–æ–≤–Ω–µ–º —Ç–æ–ø–ª–∏–≤–∞ (–æ—à–∏–±–∫–∏ –¥–∞—Ç—á–∏–∫–∞)
            const filtered = rawData.filter(entry => entry.liters > 0);
            
            if (filtered.length === 0) {
                return {
                    tankName: '–¢–æ–ø–ª–∏–≤–Ω—ã–π –±–∞–∫',
                    startLevel: 0,
                    endLevel: 0,
                    refuelings: [],
                    drains: [],
                    dailyData: [],
                    totalConsumption: 0
                };
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º)
            const sorted = filtered.slice().sort((a, b) => 
                new Date(a.wdate) - new Date(b.wdate)
            );
            
            const startLevel = sorted[0].liters;
            const endLevel = sorted[sorted.length - 1].liters;
            
            // –ò—â–µ–º –∑–∞–ø—Ä–∞–≤–∫–∏ –∏ —Å–ª–∏–≤—ã
            const refuelings = [];
            const drains = [];
            const REFUEL_THRESHOLD = 10; // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º –∑–∞–ø—Ä–∞–≤–∫–∏
            const DRAIN_THRESHOLD = -10; // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä–µ–º —Å–ª–∏–≤–∞
            
            for (let i = 1; i < sorted.length; i++) {
                const diff = sorted[i].liters - sorted[i-1].liters;
                const timeDiff = (new Date(sorted[i].wdate) - new Date(sorted[i-1].wdate)) / 1000 / 60; // –≤ –º–∏–Ω—É—Ç–∞—Ö
                
                // –ó–∞–ø—Ä–∞–≤–∫–∞: —Ä–µ–∑–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ > 10–ª –∏ –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è (< 30 –º–∏–Ω)
                if (diff > REFUEL_THRESHOLD && timeDiff < 30) {
                    refuelings.push({
                        date: sorted[i].wdate,
                        volume: Math.abs(diff).toFixed(2),
                        latitude: sorted[i].latitude,
                        longitude: sorted[i].longitude
                    });
                }
                // –°–ª–∏–≤: —Ä–µ–∑–∫–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ > 10–ª –∏ –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è (< 30 –º–∏–Ω)
                else if (diff < DRAIN_THRESHOLD && timeDiff < 30) {
                    drains.push({
                        date: sorted[i].wdate,
                        volume: Math.abs(diff).toFixed(2),
                        latitude: sorted[i].latitude,
                        longitude: sorted[i].longitude
                    });
                }
            }
            
            // –ê–Ω–∞–ª–∏–∑ –ø–æ –¥–Ω—è–º —Å —É—á–µ—Ç–æ–º –∑–∞–ø—Ä–∞–≤–æ–∫
            const dailyMap = {};
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø—Ä–∞–≤–∫–∏ –ø–æ –¥–Ω—è–º
            const refuelingsByDay = {};
            refuelings.forEach(r => {
                const dayKey = new Date(r.date).toISOString().split('T')[0];
                if (!refuelingsByDay[dayKey]) refuelingsByDay[dayKey] = 0;
                refuelingsByDay[dayKey] += parseFloat(r.volume);
            });
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Å–ª–∏–≤—ã –ø–æ –¥–Ω—è–º
            const drainsByDay = {};
            drains.forEach(d => {
                const dayKey = new Date(d.date).toISOString().split('T')[0];
                if (!drainsByDay[dayKey]) drainsByDay[dayKey] = 0;
                drainsByDay[dayKey] += parseFloat(d.volume);
            });
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º
            sorted.forEach((entry, index) => {
                const date = new Date(entry.wdate);
                const dayKey = date.toISOString().split('T')[0];
                
                if (!dailyMap[dayKey]) {
                    dailyMap[dayKey] = {
                        date: dayKey,
                        startLevel: entry.liters,
                        endLevel: entry.liters,
                        refuelings: refuelingsByDay[dayKey] || 0,
                        drains: drainsByDay[dayKey] || 0,
                        records: [],
                        mileage: 0, // –ü—Ä–æ–±–µ–≥ –≤ –∫–º
                        motorHours: 0, // –ú–æ—Ç–æ—á–∞—Å—ã
                        prevEntry: null
                    };
                } else {
                    dailyMap[dayKey].endLevel = entry.liters;
                    
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–±–µ–≥ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
                    if (dailyMap[dayKey].prevEntry) {
                        const dist = calculateDistance(
                            dailyMap[dayKey].prevEntry.latitude,
                            dailyMap[dayKey].prevEntry.longitude,
                            entry.latitude,
                            entry.longitude
                        );
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Å–∫–∞—á–∫–∏ (> 2 –∫–º –º–µ–∂–¥—É —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Ç–æ—á–∫–∞–º–∏)
                        if (dist < 2) {
                            dailyMap[dayKey].mileage += dist;
                        }
                        
                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–æ—Ç–æ—á–∞—Å—ã –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
                        const timeDiff = (new Date(entry.wdate) - new Date(dailyMap[dayKey].prevEntry.wdate)) / 1000 / 3600; // –≤ —á–∞—Å–∞—Ö
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ (> 15 –º–∏–Ω = —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ—Å—Ç–æ–π)
                        if (timeDiff < 0.25) {
                            dailyMap[dayKey].motorHours += timeDiff;
                        }
                    }
                }
                
                dailyMap[dayKey].records.push(entry.liters);
                dailyMap[dayKey].prevEntry = entry;
            });
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Ö–æ–¥ –ø–æ –¥–Ω—è–º
            const dailyData = Object.keys(dailyMap).sort().map(dayKey => {
                const day = dailyMap[dayKey];
                // –†–∞—Å—Ö–æ–¥ = –Ω–∞—á–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å - –∫–æ–Ω–µ—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å + –∑–∞–ø—Ä–∞–≤–∫–∏ - —Å–ª–∏–≤—ã
                const consumption = day.startLevel - day.endLevel + day.refuelings - day.drains;
                
                // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—Ö–æ–¥ –±–µ–∑ —É—á–µ—Ç–∞ –∑–∞–ø—Ä–∞–≤–æ–∫/—Å–ª–∏–≤–æ–≤ (–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–µ–≥–æ)
                const actualConsumption = day.startLevel - day.endLevel;
                
                // –°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –ª/100–∫–º (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞)
                // –ï—Å–ª–∏ actualConsumption –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π (–±—ã–ª–∞ –∑–∞–ø—Ä–∞–≤–∫–∞), –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ–º –≤ —Å—Ä–µ–¥–Ω–µ–º —Ä–∞—Å—Ö–æ–¥–µ
                let avgConsumption = 0;
                if (day.mileage > 0 && actualConsumption > 0) {
                    avgConsumption = (actualConsumption / day.mileage * 100);
                }
                
                return {
                    date: dayKey,
                    startLevel: day.startLevel.toFixed(2),
                    endLevel: day.endLevel.toFixed(2),
                    refuelings: day.refuelings.toFixed(2),
                    drains: day.drains.toFixed(2),
                    consumption: Math.max(0, consumption).toFixed(2),
                    mileage: day.mileage.toFixed(2),
                    motorHours: day.motorHours.toFixed(2),
                    avgConsumption: avgConsumption.toFixed(2),
                    actualConsumption: actualConsumption // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Ç–æ–≥–æ–≤—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
                };
            });
            
            // –û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ –∑–∞ –ø–µ—Ä–∏–æ–¥
            const totalRefuelings = refuelings.reduce((sum, r) => sum + parseFloat(r.volume), 0);
            const totalDrains = drains.reduce((sum, d) => sum + parseFloat(d.volume), 0);
            const totalConsumption = startLevel - endLevel + totalRefuelings - totalDrains;
            
            // –û–±—â–∏–π –ø—Ä–æ–±–µ–≥ –∏ –º–æ—Ç–æ—á–∞—Å—ã
            const totalMileage = dailyData.reduce((sum, d) => sum + parseFloat(d.mileage), 0);
            const totalMotorHours = dailyData.reduce((sum, d) => sum + parseFloat(d.motorHours), 0);
            
            // –î–ª—è —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞ —Å—É–º–º–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–Ω–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º —Ä–∞—Å—Ö–æ–¥–æ–º (–≥–¥–µ –Ω–∞—á–∞–ª–æ > –∫–æ–Ω–µ—Ü)
            const totalActualConsumption = dailyData.reduce((sum, d) => {
                return d.actualConsumption > 0 ? sum + d.actualConsumption : sum;
            }, 0);
            const totalMileageWithConsumption = dailyData.reduce((sum, d) => {
                return d.actualConsumption > 0 ? sum + parseFloat(d.mileage) : sum;
            }, 0);
            const totalAvgConsumption = totalMileageWithConsumption > 0 ? (totalActualConsumption / totalMileageWithConsumption * 100) : 0;
            
            return {
                tankName: '–¢–æ–ø–ª–∏–≤–Ω—ã–π –±–∞–∫',
                startLevel: startLevel.toFixed(2),
                endLevel: endLevel.toFixed(2),
                refuelings: refuelings,
                drains: drains,
                dailyData: dailyData,
                totalConsumption: Math.max(0, totalConsumption).toFixed(2),
                totalRefuelings: totalRefuelings.toFixed(2),
                totalDrains: totalDrains.toFixed(2),
                totalMileage: totalMileage.toFixed(2),
                totalMotorHours: totalMotorHours.toFixed(2),
                totalAvgConsumption: totalAvgConsumption.toFixed(2)
            };
        }
        
        function createSummaryTable(analysis) {
            const div = document.createElement('div');
            div.innerHTML = `
                <h2>–°–≤–æ–¥–∫–∞ –ø–æ –±–∞–∫–∞–º</h2>
                <table>
                    <thead>
                        <tr>
                            <th>–ë–∞–∫–∏</th>
                            <th>–£—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞ –Ω–∞ –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞, –ª</th>
                            <th colspan="2">–ó–∞–ø—Ä–∞–≤–∫–∏</th>
                            <th colspan="2">–°–ª–∏–≤—ã</th>
                            <th>–£—Ä–æ–≤–µ–Ω—å —Ç–æ–ø–ª–∏–≤–∞ –Ω–∞ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞, –ª</th>
                            <th>–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥, –ª</th>
                            <th>–ü—Ä–æ–±–µ–≥, –∫–º</th>
                            <th>–ú–æ—Ç–æ—á–∞—Å—ã</th>
                            <th>–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥, –ª/100–∫–º</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th>–ö–æ–ª-–≤–æ</th>
                            <th>–û–±—ä–µ–º, –ª</th>
                            <th>–ö–æ–ª-–≤–æ</th>
                            <th>–û–±—ä–µ–º, –ª</th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${analysis.tankName}</td>
                            <td>${analysis.startLevel}</td>
                            <td>${analysis.refuelings.length}</td>
                            <td>${analysis.totalRefuelings}</td>
                            <td>${analysis.drains.length}</td>
                            <td>${analysis.totalDrains}</td>
                            <td>${analysis.endLevel}</td>
                            <td>${analysis.totalConsumption}</td>
                            <td>${analysis.totalMileage}</td>
                            <td>${analysis.totalMotorHours}</td>
                            <td>${analysis.totalAvgConsumption}</td>
                        </tr>
                        <tr class="summary-row">
                            <td>–í—Å–µ</td>
                            <td>${analysis.startLevel}</td>
                            <td>${analysis.refuelings.length}</td>
                            <td>${analysis.totalRefuelings}</td>
                            <td>${analysis.drains.length}</td>
                            <td>${analysis.totalDrains}</td>
                            <td>${analysis.endLevel}</td>
                            <td>${analysis.totalConsumption}</td>
                            <td>${analysis.totalMileage}</td>
                            <td>${analysis.totalMotorHours}</td>
                            <td>${analysis.totalAvgConsumption}</td>
                        </tr>
                    </tbody>
                </table>
            `;
            return div;
        }
        
        function createRefuelingsTable(analysis) {
            const div = document.createElement('div');
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–ø—Ä–∞–≤–∫–∏ –∏ —Å–ª–∏–≤—ã –≤ –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É
            const events = [];
            
            analysis.refuelings.forEach(r => {
                events.push({
                    date: r.date,
                    type: '–ó–∞–ø—Ä–∞–≤–∫–∞',
                    volume: r.volume,
                    latitude: r.latitude,
                    longitude: r.longitude
                });
            });
            
            analysis.drains.forEach(d => {
                events.push({
                    date: d.date,
                    type: '–°–ª–∏–≤',
                    volume: d.volume,
                    latitude: d.latitude,
                    longitude: d.longitude
                });
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
            events.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let eventsHTML = '';
            if (events.length > 0) {
                // –ü—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–≥–µ–æ–∫–æ–¥–∏–Ω–≥ –æ—Ç–∫–ª—é—á–µ–Ω –∏–∑-–∑–∞ CORS)
                eventsHTML = events.map(e => `
                    <tr style="${e.type === '–°–ª–∏–≤' ? 'background-color: #ffebee;' : ''}">
                        <td>${new Date(e.date).toLocaleString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        })}</td>
                        <td><strong>${e.type}</strong></td>
                        <td>${e.volume}</td>
                        <td>${e.latitude.toFixed(6)}, ${e.longitude.toFixed(6)}</td>
                    </tr>
                `).join('');
            } else {
                eventsHTML = '<tr><td colspan="4">–ù–µ—Ç –∑–∞–ø—Ä–∞–≤–æ–∫ –∏ —Å–ª–∏–≤–æ–≤</td></tr>';
            }
            
            div.innerHTML = `
                <h2>–ó–∞–ø—Ä–∞–≤–∫–∏ –∏ —Å–ª–∏–≤—ã</h2>
                <h3>${analysis.tankName}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞/–≤—Ä–µ–º—è</th>
                            <th>–¢–∏–ø</th>
                            <th>–û–±—ä–µ–º, –ª</th>
                            <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${eventsHTML}
                    </tbody>
                </table>
            `;
            return div;
        }
        
        function createDailyTable(analysis) {
            const div = document.createElement('div');
            
            let dailyHTML = '';
            
            if (analysis.dailyData.length > 0) {
                dailyHTML = analysis.dailyData.map(day => {
                    return `
                        <tr>
                            <td>${new Date(day.date).toLocaleDateString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            })}</td>
                            <td>${day.startLevel}</td>
                            <td>${day.endLevel}</td>
                            <td>${day.refuelings}</td>
                            <td>${day.drains}</td>
                            <td>${day.consumption}</td>
                            <td>${day.mileage}</td>
                            <td>${day.motorHours}</td>
                            <td>${day.avgConsumption}</td>
                        </tr>
                    `;
                }).join('');
                
                // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
                const totalRefuel = analysis.dailyData.reduce((sum, d) => sum + parseFloat(d.refuelings), 0);
                const totalDrain = analysis.dailyData.reduce((sum, d) => sum + parseFloat(d.drains), 0);
                const totalConsump = analysis.dailyData.reduce((sum, d) => sum + parseFloat(d.consumption), 0);
                const totalMileage = analysis.dailyData.reduce((sum, d) => sum + parseFloat(d.mileage), 0);
                const totalMotorHours = analysis.dailyData.reduce((sum, d) => sum + parseFloat(d.motorHours), 0);
                // –°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ = —Å—É–º–º–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–Ω–∏ —Å —Ä–∞—Å—Ö–æ–¥–æ–º
                const totalActualConsumption = analysis.dailyData.reduce((sum, d) => {
                    return d.actualConsumption > 0 ? sum + d.actualConsumption : sum;
                }, 0);
                const totalMileageWithConsumption = analysis.dailyData.reduce((sum, d) => {
                    return d.actualConsumption > 0 ? sum + parseFloat(d.mileage) : sum;
                }, 0);
                const totalAvgConsump = totalMileageWithConsumption > 0 ? (totalActualConsumption / totalMileageWithConsumption * 100) : 0;
                
                dailyHTML += `
                    <tr class="summary-row">
                        <td>–ò—Ç–æ–≥–æ</td>
                        <td>${analysis.startLevel}</td>
                        <td>${analysis.endLevel}</td>
                        <td>${totalRefuel.toFixed(2)}</td>
                        <td>${totalDrain.toFixed(2)}</td>
                        <td>${totalConsump.toFixed(2)}</td>
                        <td>${totalMileage.toFixed(2)}</td>
                        <td>${totalMotorHours.toFixed(2)}</td>
                        <td>${totalAvgConsump.toFixed(2)}</td>
                    </tr>
                `;
            } else {
                dailyHTML = '<tr><td colspan="9">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            }
            
            div.innerHTML = `
                <h2>–°—É—Ç–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞</h2>
                <table>
                    <thead>
                        <tr>
                            <th>–î–µ–Ω—å</th>
                            <th>–£—Ä–æ–≤–µ–Ω—å –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–Ω—è, –ª</th>
                            <th>–£—Ä–æ–≤–µ–Ω—å –Ω–∞ –∫–æ–Ω–µ—Ü –¥–Ω—è, –ª</th>
                            <th>–ó–∞–ø—Ä–∞–≤–∫–∏, –ª</th>
                            <th>–°–ª–∏–≤—ã, –ª</th>
                            <th>–†–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞, –ª</th>
                            <th>–ü—Ä–æ–±–µ–≥, –∫–º</th>
                            <th>–ú–æ—Ç–æ—á–∞—Å—ã</th>
                            <th>–°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥, –ª/100–∫–º</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${dailyHTML}
                    </tbody>
                </table>
            `;
            return div;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', loadReport);
    </script>
</body>
</html>