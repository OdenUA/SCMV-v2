# SCMV v2 — локальный инструмент просмотра и анализа треков

Version: v1.0.0 — project baseline (start)

Changelog (start): initial baseline commit and README analysis.

Это приватный (личный) проект — интерфейс для визуализации и анализа GPS-треков устройств. Репозиторий не предназначен для совместной разработки в текущем виде; README содержит анализ кода и описание функционала, чтобы вы быстрее ориентировались в кодовой базе.

Файлы подключаются статически (через теги <script> в `index.html`), сборок и пакетных менеджеров нет — всё запускается как статическая веб-страница или через простой локальный HTTP-сервер.

---

Содержание этого README:
- Обзор функций
- Ключевые файлы и их назначение
- Как запустить локально
- Внутренняя архитектура и взаимосвязи

---

## Обзор функций (что умеет приложение)

- Авторизация
   - В `ws.js` реализован WebSocket клиент, отправка/приём запросов и простая логика автологина (localStorage).

- Загрузка и отображение треков
   - Запросы: `Vehicle Track` (традиционный трек) и `Vehicle Track` с `_raw` флагом (points-only / raw track).
   - Отрисовка: треки рисуются как полигоны/полилинии в `device_track.js` (слои в `trackLayerGroup`).
   - Визуализация направлений (arrow-decorator) через `leaflet-polyline-decorator`.

- Выявление аномалий
   - В `device_track.js` есть логика выявления разрывов, бросков позиции, скорости и «вне границ» (out of bounds).
   - Аномалии добавляются в список и в таблицу (правая панель), с возможностью подсветки сегментов на карте.

- Старт/Стоп (Parking / Stops)
   - `stops.js` обрабатывает серверный ответ Start/Stop Accumulation и рисует маркеры стоянок в `parkingLayerGroup`.
   - Маркеры имеют всплывающие окна с деталями и кликом по записи в таблице можно перейти к маркеру.

- Ручное построение маршрута (route-mode)
   - `route.js` реализует "монопольный" режим построения маршрута: при включении маршрута клики по карте, трекам и маркерам добавляют точки маршрута (накапливаются до 25 точек).
   - Поддержка выстраивания маршрута по дорогам через OSRM (`buildRoadRoute`) и генерация ссылки на Google Maps (`buildGoogleMapsRouteManual`).
   - Управление: кнопка-переключатель (левый верх), сброс маршрута, удаление последней точки и отображение информации о маршруте.

- Таблицы и отчёты
   - Множество табличных представлений: аномалии, Device Log, Device Alarm, Full Device Track и отчёты по пробегам.
   - Универсальная утилита `populateTable` в `utils.js` для отрисовки таблиц.

- Удобства UI
   - Плавающая панель фильтров (выбор устройства, даты), адаптивные кнопки, drag-to-resize карты, toast-уведомления и вспомогательные кнопки.

---

## Ключевые файлы и их роли

- `index.html` — точка входа, подключение всех скриптов и CDN-зависимостей (Leaflet, polyline decorator), объявление DOM-панелей.
- `globals.js` — глобальные переменные, ссылки на DOM-элементы и начальная конфигурация (переменные состояния и слоёв карты).
- `map.js` — инициализация Leaflet-карты, кастомные контролы (route control, tracks/parking toggle), resize handle и вспомогательные UI-элементы.
- `route.js` — режим ручного построения маршрута, хранение точек, сборка маршрута по OSRM, сброс и отображение информации о маршруте.
- `device_track.js` — основная логика обработки треков: парсинг дат, построение полилиний, выявление аномалий, клики по трекам (показ ближайшей точки) и отрисовка старт/финиш маркеров.
- `stops.js` — обработка серверного ответа Start/Stop и отрисовка стоянок (маркер + popup + взаимодействия с таблицей).
- `mileage.js` — логика отчётов по пробегам (запросы, обработка и визуализация результатов). (см. файл для деталей)
- `device_log.js` — обработка и отображение логов устройства (UI таблицы и вспомогательные операции).
- `ws.js` — управляющий модуль WebSocket: отправка/приём команд, маршрутизация ответов к соответствующим обработчикам и обновление UI по полученным данным.
- `ui.js` — вспомогательная логика UI (кнопки, диалоги, копирование/сбросы, панели, стили кнопок).
- `utils.js` — утилитарные функции: парсинг дат, конвертации, вспомогательные рендереры таблиц и пр.
- `style.css` — основной набор стилей.

---

## Как запустить локально

1. (Опционально) Клонируйте репозиторий:

    git clone https://github.com/OdenUA/SCMV-v2.git

2. Запустите простой локальный HTTP-сервер в корне проекта (рекомендуется):

    PowerShell (Windows):
    ```powershell
    cd "d:\scmv\SCMV v2"
    python -m http.server 8000
    # или (если есть npm): npx http-server -p 8000
    ```

3. Откройте http://localhost:8000 в браузере.

Примечание: приложение ожидает подключение WebSocket к адресу `wsUrl` (определён в `globals.js`). Для работы с реальным сервером убедитесь, что WebSocket сервер доступен и возвращает ожидаемые форматы ответов. В противном случае вы сможете тестировать отрисовку локальных треков, режим маршрута и UI без WS.

---

## Внутренняя архитектура и потоки данных

- WS → `ws.js`
   - Входящие сообщения поступают в `ws.js:onmessage`, где в зависимости от `data.name` они перенаправляются в соответствующие обработчики (vehicle lists, mileage, track, startstop и т.д.).

- Треки → `device_track.js`
   - Когда приходит ответ `Vehicle Track`, `ws.js` вызывает `processDeviceTrack(response)`.
   - `processDeviceTrack` разбивает точки на сегменты, рисует polylines, вычисляет аномалии и создаёт таблицу аномалий.

- Стоянки → `stops.js`
   - Серверный ответ Startstop Accumulation преобразуется в `startstopStops`, а затем `rebuildStopMarkers` рисует маркеры стоянок.

- Режим маршрута → `route.js`
   - При включении маршрута регистрируется «монопольный» обработчик кликов карты (`onRouteMapClick`). Во время режима подавляются попапы и клики по объектам перенаправляются на добавление точки маршрута. После формирования точек можно попытаться построить маршрут по дорогам через OSRM.

---
